{% extends "auctions/layout.html" %}

{% block body %}
    {% if not listing.is_active and user.is_authenticated and user == listing.winner %}
        <div class="alert alert-success" role="alert">
            Congratulation <strong>{{ user.username }}</strong>. You've won this auction!
        </div>
    {% elif not listing.is_active and not listing.winner %}
        <div class="alert alert-success" role="alert">
            This auction have been closed without a winner.
        </div>
    {% elif not listing.is_active and user != listing.winner %}
        <div class="alert alert-success" role="alert">
            This auction have been closed. The auction winner is <strong>{{ listing.winner.username }}</strong>.
        </div>
    {% endif %}

    <div class="listing">   
        <h3>{{ listing.title }} 
            {% if listing in user.wishlist.all %}
                (wishlisted)
            {% endif %}
        </h3>
        <br>
        <h3>description:</h3>
        <p>{{ listing.description }}</p>
        <p>Category: {{ listing.category }} </p>
        <p>Current price: ${{ listing.bid_amount }}</p>
        

        {% if listing.image_url %}
            <img src="{{listing.image_url}}" alt="image of: {{listing.title}}" width="200px">
        {% endif%}

        {% if user.is_authenticated %}
        <div class="bid-section">
            <form id="bid" method="POST" action="{% url 'place_bid' listing.id %}">
                {% csrf_token %}
                <input type="number" name="bid_amount" step="0.01" min="{{ listing.bid_amount }}" placeholder= "$20" required>
                <button type="submit">Place new bid</button>
            </form>
        </div>
        {% endif %}
<br>
        {% if user.is_authenticated and listing in user.wishlist.all %}
            <form method="POST" action="{% url 'toggle_wishlist' listing.id %}">
                {% csrf_token %}
                <button type="submit">Remove from wishlist</button>
            </form>
        {% else %}
            <form method="POST" action="{% url 'toggle_wishlist' listing.id %}">
                {% csrf_token %}
                <button type="submit">Add to wishlist</button>
            </form>
        {% endif %}

        {% if listing.is_active and user.is_authenticated and user == listing.owner %}
            <form method="POST" action="{% url 'close-auction' listing.id %}">
                {% csrf_token %}
                <br>
                <button class="btn btn-danger" type="submit">Close listing</button>
            </form>
        {% endif %}
    </div>
<br>
    <div class="comments-section">
        <h3>Comments:</h3>
        {% if comments %}
        <div class="comments-list">
            {% for comment in comments %}
                <div class="comment">
                    <strong>{{ comment.user.username }}</strong> said:
                    <p>{{ comment.text }}</p>
                </div>
            {% endfor %}
        </div>
        {% else %}
            <p> No comments yet. Be the first to comment!</p>
        {% endif %}
    </div>
<br>
    {% if user.is_authenticated %}
    <div class="add-comment-section">
        <h3>Add a comment:</h3>
        <form method="POST" action="{% url 'add_comment' listing.id %}">
            {% csrf_token %}
            <textarea name="comment_text" rows="4" cols="50" minlength="5" placeholder="Type your comment here..." required></textarea>
            <br>
            <button type="submit">Submit Comment</button>
        </form>
    </div>
    {% endif %}

{% endblock %}